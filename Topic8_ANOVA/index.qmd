---
title: "Topic 8: Analysis of Variance (ANOVA)"
format: 
  revealjs:
    theme: OSU.scss
    chalkboard: false
    html-math-method: mathjax
    multiplex: true
editor: visual
---

```{r}
library(tidyverse)
```

```{r}
boxes <- read_csv("boxes.csv")
```

## Download or print notes to PDF {.smaller}

If you'd like to export this presentation to a PDF, do the following

::: nonincremental
1.  Toggle into Print View using the E key.
2.  Open the in-browser print dialog (CTRL/CMD+P)
3.  Change the **Destination** to **Save as PDF**.
4.  Change the **Layout** to **Landscape**.
5.  Change the **Margins** to **None**.
6.  Enable the **Background graphics** option.
7.  Click **Save**.
:::

This feature has been confirmed to work in Google Chrome and Firefox.

##  {.smaller}

### Motivating Exercises

In each of the side-by-side boxplots below, you'll see data sampled from three different populations. The red dot in each plot corresponds to the sample mean.

::::::: columns
:::: {.column width="60%"}
::: {.fragment fragment-index="1"}
**Example 1**

```{r}
#| fig-height: 5
set.seed(1893249793)

mu_1 <- 25
mu_2 <- 35
mu_3 <- 15

s_1 <- 50
s_2 <- 3

samp1 <- rnorm(50, mu_1, s_1)
samp2 <- rnorm(50, mu_2, s_1)
samp3 <- rnorm(50, mu_3, s_1)

plot1_dat <- data.frame("sample" = c(rep("Sample 1", 50), rep("Sample 2", 50), rep("Sample 3", 50)),
                        "data" = c(samp1, samp2, samp3))

plot1 <- ggplot(plot1_dat, aes(x = sample, y = data)) + 
  geom_boxplot() + 
  stat_summary(fun.y=mean, geom="point", color = "red", size=3) +
  labs(x = "", y = "") + 
  theme(axis.text = element_text(size = 16))

plot1

```
:::

[üìä In Poll Everywhere, comment on whether you think the means of the populations from which the above three samples came are the same, similar, or significantly different from one another.]{.fragment fragment-index="2"}
::::

:::: {.column width="40%"}
::: {.fragment fragment-index="2"}
![](pollev_qr.png){fig-alt="QR code to PollEv.com/erinhowardstats"}

**Answer the question at PollEv.com/erinhowardstats**
:::
::::
:::::::

##  {.smaller}

### Motivating Exercises

In each of the side-by-side boxplots below, you'll see data sampled from three different populations. The red dot in each plot corresponds to the sample mean.

::::::: columns
:::: {.column width="60%"}
::: {.fragment fragment-index="1"}
**Example 2**

```{r}
#| fig-height: 5
set.seed(1893249793)

samp4 <- rnorm(50, mu_1, s_2)
samp5 <- rnorm(50, mu_2, s_2)
samp6 <- rnorm(50, mu_3, s_2)

plot2_dat <- data.frame("sample" = c(rep("Sample 4", 50), rep("Sample 5", 50), rep("Sample 6", 50)),
                        "data" = c(samp4, samp5, samp6))

plot2 <- ggplot(plot2_dat, aes(x = sample, y = data)) + 
  geom_boxplot() + 
  stat_summary(fun.y=mean, geom="point", color = "red", size=3) +
  labs(x = "", y = "") + 
  theme(axis.text = element_text(size = 16))

plot2
```
:::

[üìä Again, in Poll Everywhere, comment on whether you think the means of the populations from which the above three samples came are the same, similar, or significantly different from one another.]{.fragment fragment-index="2"}
::::

:::: {.column width="40%"}
::: {.fragment fragment-index="2"}
![](pollev_qr.png){fig-alt="QR code to PollEv.com/erinhowardstats"}

**Answer the question at PollEv.com/erinhowardstats**
:::
::::
:::::::

##  {.smaller}

### Motivating Exercises

¬†

¬†

::::: columns
::: column
```{r}
plot1
```
:::

::: column
```{r}
plot2
```
:::
:::::

## Analysis of Variance (ANOVA) {.smaller}

::: incremental
-   An ANOVA is a holistic procedure used to test whether there is evidence that [at least one pair of populations]{.fragment .highlight-red} have different means when comparing more than two populations.

-   Why is it called an *Analysis of **Variance*** if the goal is to compare means?

    -   In an ANOVA, we'll compare the variability *across* groups to the variability *within* groups.
:::

::: fragment
```{r}
#| fig-height: 3
plot2
```
:::

## Notation

-   $k=$ [number of groups (i.e. number of populations of interest)]{.fragment}

-   $n=$ [overall sample size (i.e. size of all samples combined)]{.fragment}

-   $\overline{x}=$ [overall sample mean (i.e. mean of all observations ignoring groups)]{.fragment}

-   $n_i=$ [sample size of the $i$th group]{.fragment}

-   $\mu_i=$ [population mean of the $i$th group]{.fragment}

-   $\overline{x}_i=$ [sample mean of the $i$th group]{.fragment}

-   $s_i=$ [sample standard deviation of the $i$th group]{.fragment}

## ANOVA Procedure Steps

¬†

::: fragment
### 1. Identify the question and parameters of interest

[Are there differences in the means of the multiple populations?]{.fragment}
:::

¬†

::: fragment
**Parameters of interest:**

[$\mu_1, \mu_2, ..., \mu_k$, the population means of the $k$ groups]{.fragment}
:::

## Example Problem Ô∏èüì¶ {.smaller}

[A packaging manufacturer is interested in determining if there is a significant difference in the mean compression strength of four different packaging materials used to construct a standard shipping container. We'll consider a significant result using the $\alpha = 0.05$ significance level.]{.fragment style="color:blue;"}

¬†

[**Question of interest:** Is there is a difference in the average (mean) compression strength between the four materials?]{.fragment style="color:blue;"}

¬†

[**Parameters of interest:**]{.fragment style="color:blue;"}

[$\mu_1$, mean compression strength for **all** shipping containers constructed with Material **1**]{.fragment style="color:blue;"}

[$\mu_2$, mean compression strength for **all** shipping containers constructed with Material **2**]{.fragment style="color:blue;"}

[$\mu_3$, mean compression strength for **all** shipping containers constructed with Material **3**]{.fragment style="color:blue;"}

[$\mu_4$, mean compression strength for **all** shipping containers constructed with Material **4**]{.fragment style="color:blue;"}

## ANOVA Procedure Steps

¬†

### 2. Set Up the Null and Alternative Hypotheses

¬†

[$H_0: \mu_1 = \mu_2 = ... = \mu_k$]{.fragment}

¬†

[$H_A:$ At least one mean is different]{.fragment}

## Participation Question üìä

¬†

Write the null hypothesis for our [packaging example]{style="color:blue;"}.

¬†

**Answer the question at PollEv.com/erinhowardstats**

![](pollev_qr.png){fig-alt="QR code to PollEv.com/erinhowardstats"}

## 2. Set Up the Null and Alternative Hypotheses

¬†

[**Example Ô∏èüì¶**]{style="color:blue;"}

¬†

[$H_0: \mu_1 = \mu_2 = \mu_3 = \mu_4$]{.fragment style="color:blue;"}

¬†

[$H_A:$ At least one packaging material has a different compression strength, on average, than the others.]{.fragment style="color:blue;"}

##  {.smaller}

### ANOVA Procedure Steps

#### 3. Collect and Summarize the Data

```{r include=FALSE}
xbar <- mean(boxes$strength)
summary_table <- boxes |>
  group_by(as.factor(material)) |>
  summarise(means = round(mean(strength),2), 
            sds = round(sd(strength),2))
summary_table
```

::::::::: columns
:::::: {.column width="35%"}
::: fragment
[**Example Ô∏èüì¶**]{style="color:blue;"}

22 boxes are constructed for each packaging material type.
:::

::: fragment
$k =$ 4

$n =$ 88

$\overline{x} =$ `{r} round(xbar,2)` lb
:::

::: fragment
```{r}
library(gt)
summary_table |>
  gt() |>
  cols_label(
    `as.factor(material)` = "Material", 
    means = "Sample Mean (lb)", 
    sds = "Sample Standard Deviation (lb)"
  )
```
:::
::::::

:::: {.column width="65%"}
::: fragment
```{r}
ggplot(boxes, aes(x = strength, y = as.factor(material))) + 
  geom_boxplot(aes(fill = as.factor(material))) + 
  labs(x = "Compression Strength (lb)", 
       y = "Material") + 
  scale_fill_viridis_d(guide = "none") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 16), 
        axis.text = element_text(size = 16))
```
:::
::::
:::::::::

##  {.smaller}

### ANOVA Procedure Steps

#### 4. The $F$ test statistic

[In order to answer our question of interest, we must compare the variability between groups to the variability within groups.]{.fragment}

::::::: fragment
:::::: columns
::: {.column width="45%"}
**Mean Square Between Groups (MSG)**

-   Measures the average variability [between]{style="color:red;"} groups

[$$MSG = \frac{1}{k-1}\sum \limits_{i=1}^k n_i (\overline{x}_i - \overline{x})^2$$]{.fragment}
:::

::: {.column width="5%"}
:::

::: {.column width="45%"}
**Mean Square Error (MSE)**

-   Measures the average variability [within]{style="color:red;"} groups

[$$MSE = \frac{1}{n-k}\sum \limits_{i=1}^k (n_i-1)s_i^2 $$]{.fragment}
:::
::::::
:::::::

::: fragment
The test statistic is the ratio of the average between group variability to the average within group variability $$F = \frac{MSG}{MSE}$$
:::

## ANOVA Procedure Steps {.smaller}

### 4. The $F$ test statistic

¬†

[**Example Ô∏èüì¶**]{style="color:blue;"}

```{r}
mod <- lm(strength ~ as.factor(material), data = boxes)

```

[MSG = 998.57]{style="\"color:blue;"}

[MSE = 81.60]{style="\"color:blue;"}

[$F=\frac{MSG}{MSE} = 12.24$]{.fragment style="\"color:blue;"}

¬†

[*These values were determined in R. Code and R output coming up!*]{.fragment style="\"color:blue;"}

##  {.smaller}

### ANOVA Procedure Steps

#### 5. Determine the Null Distribution

[There are two conditions that need to be met in order to assume the upcoming null distribution:]{.fragment}

::: incremental
1.  The samples sizes must be sufficiently large.

-   If $n_i\geq 30$, we can move forward.

-   If any of the sample sizes are less than 30, we need to look at the sampled distribution(s) of the small sample(s). If there are no clear outliers or strong skewness in the sampled data, we can move forward.

2.  We need to be able to assume constant variance across the groups.

-   To assess this condition, we should use the sampled distributions and make a judgement as to whether the standard deviations are similar between samples.
:::

[If the above conditions are met, under the null hypothesis, the test statistic, $F = \frac{MSG}{MSE}$, follows an *F* distribution with $k-1$ and $n-k$ degrees of freedom.]{.fragment}

##  {.smaller}

### ANOVA Procedure Steps

#### 5. Determine the Null Distribution

[If the previously mentioned conditions are met, under the null hypothesis, the test statistic, $F = \frac{MSG}{MSE}$, follows an *F* distribution with $k-1$ and $n-k$ degrees of freedom.]{.fragment}

::::::: columns
:::: {.column width="60%"}
::: fragment
```{r}
ggplot(data = data.frame(x = c(0, 6)), aes(x)) +
  stat_function(fun = df, n = 101, args = list(df1 = 3, df2=84), color = "darkgreen", linewidth = 2) + 
  ylab("") +
  xlab("") + 
  theme_bw() 
```
:::
::::

:::: {.column width="40%"}
::: incremental
-   The $F$ distribution is right skewed whose support is $(0, \infty)$

-   Its shape is defined by **two** values:

    -   The numerator degrees of freedom, $k-1$

    -   The denonminator degrees of freedom, $n-k$

-   Denoted: [$F_{k-1, n-k}$]{.fragment}
:::
::::
:::::::

<!-- ## Example Problem Ô∏èüì¶Ô∏è {.smaller} -->

<!-- ```{r} -->

<!-- summary_table |> -->

<!--   gt() |> -->

<!--   cols_label( -->

<!--     `as.factor(material)` = "Material",  -->

<!--     means = "Sample Mean (lb)",  -->

<!--     sds = "Sample Standard Deviation (lb)" -->

<!--   ) -->

<!-- ``` -->

<!-- :::{.r-stack} -->

<!-- ```{r} -->

<!-- #| fig-width: 12 -->

<!-- ggplot(boxes, aes(x = strength, y = as.factor(material))) +  -->

<!--   geom_boxplot(aes(fill = as.factor(material))) +  -->

<!--   labs(x = "Compression Strength (lb)",  -->

<!--        y = "Material") +  -->

<!--   scale_fill_viridis_d(guide = "none") +  -->

<!--   theme_bw() +  -->

<!--   theme(axis.title = element_text(size = 16),  -->

<!--         axis.text = element_text(size = 16)) -->

<!-- ``` -->

<!-- ::: -->

## Participation Question üìä {.smaller}

::::: columns
::: {.column width="35%"}
Assess the sample size condition needed to perform an ANOVA F test for our [packaging materials example]{style="color:blue;"}.

¬†

**Answer the question at PollEv.com/erinhowardstats**

![](pollev_qr.png){fig-alt="QR code to PollEv.com/erinhowardstats"}
:::

::: {.column width="65%"}
```{r}
ggplot(boxes, aes(x = strength, y = as.factor(material))) + 
  geom_boxplot(aes(fill = as.factor(material))) + 
  labs(x = "Compression Strength (lb)", 
       y = "Material") + 
  scale_fill_viridis_d(guide = "none") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 16), 
        axis.text = element_text(size = 16))
```
:::
:::::

## Participation Question üìä {.smaller}

::::: columns
::: {.column width="40%"}
Consider the constant variance assumption needed to perform an ANOVA F test. Do you think the condition is met for our [packaging materials example]{style="color:blue;"}? Why or why not?

**Answer the question at PollEv.com/erinhowardstats**

![](pollev_qr.png){fig-alt="QR code to PollEv.com/erinhowardstats"}
:::

::: {.column width="60%"}
```{r}
ggplot(boxes, aes(x = strength, y = as.factor(material))) + 
  geom_boxplot(aes(fill = as.factor(material))) + 
  labs(x = "Compression Strength (lb)", 
       y = "Material") + 
  scale_fill_viridis_d(guide = "none") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 16), 
        axis.text = element_text(size = 16))
```

¬†

```{r}
summary_table |>
  gt() |>
  cols_label(
    `as.factor(material)` = "Material", 
    means = "Sample Mean (lb)", 
    sds = "Sample Standard Deviation (lb)"
  )
```
:::
:::::

## ANOVA Procedure Steps {.smaller}

### 5. Determine the Null Distribution

[**Example Ô∏èüì¶**]{style="color:blue;"}

::: fragment
[The null distribution for this hypothesis test is an *F* distribution with $n-1=4-1=3$ and $n-k=88-4=84$ degrees of freedom.]{style="color:blue;"}

```{r}
#| fig-height: 4
ggplot(data = data.frame(x = c(0, 6)), aes(x)) +
  stat_function(fun = df, n = 200, args = list(df1 = 3, df2=84), color = "darkgreen", linewidth = 1) + 
  ylab("") +
  xlab("") + 
  theme_bw()
```
:::

## ANOVA Procedure Steps {.smaller}

### 6. Calculate the p-value

[Recall that the p-value represents the probability of observing data as or more extreme than our current dataset according to the alternative hypothesis, if the null hypothesis were true.]{.fragment}

::::::: columns
:::: {.column width="60%"}
::: fragment
```{r}
#| fig-height: 3
#| fig-alt: "An F distribution with the F statistic indicated. The area under the curve to the right of the F statistic is shaded."
ggplot(data = data.frame(x = c(0, 13)), aes(x)) +
  stat_function(fun = df, n = 200, args = list(df1 = 3, df2=84), color = "darkgreen", linewidth = 2) + 
  ylab("") +
  xlab("") + 
  theme_bw() +
  geom_area(stat = "function", 
            fun = df,
            args = list(df1 = 3, df2=84),
            fill = "darkgreen", 
            alpha = .5,
            xlim = c(12, 13)) + 
  geom_segment(aes(x = 12, y = 0, xend = 12, yend = 0.4), 
               size = 1.5) + 
  geom_text(x=12, y=0.45, label="F test statistic", size =7)
```
:::
::::

:::: {.column width="40%"}
::: {.fragment style="border: 2px solid #2A788EFF; text-align: center"}
In an ANVOA *F* test, the p-value is always the area under the null distribution curve to the **right** of the *F* test statistic.
:::
::::
:::::::

::: fragment
**R code:** [`1-pf(F, k-1, n-k)`]{.fragment}
:::

## Example Problem Ô∏èüì¶

[In practice, the ANOVA calculations (e.g., MSG, MSE, F statistic, p-value) won't be computed by hand. When we perform an ANOVA F test, we'll use R to complete the calculations.]{style="color:blue;"}

¬†

```{r}
anova(mod)
```

<!-- Typically results are displayed in an **ANOVA table**. -->

<!-- |           | df  | Sum of Squares | Mean Squares | F     | p-value | -->

<!-- |-----------|-----|----------------|--------------|-------|---------| -->

<!-- | Transport | 2   | 0.450          | 0.225        | 0.171 | 0.843   | -->

<!-- | Residuals | 247 | 324.311        | 1.313        | --    | --      | -->

## ANOVA Procedure Steps

### 8. Make a conclusion

[Write a 2-part conclusion (we'll exclude a single point estimate and confidence interval). The conclusion should be written in the context of the problem and contain the following components:]{.fragment}

::: incremental
1.  A statement for the strength of evidence in favor the alternative hypothesis.

2.  Whether to reject or fail to reject the null hypothesis.
:::

## Example Problem Ô∏èüì¶ {.smaller}

Using the ANOVA output, write a conclusion for this test using a $\alpha=0.05$ significance level.

```{r}
anova(mod)
```

[There is **convincing evidence** to suggest that the average compression strength differs across the four packing materials. At the 0.05 significance level, we **reject the null hypothesis** that the average compression strength is equal across materials.]{.fragment style="color:blue;"}

```{r}
library(countdown)

countdown(minutes = 1, seconds = 30)
```

## Multiple Comparisons {.smaller}

::: incremental
-   When we reject the null hypothesis in an ANOVA analysis, we might wonder, which of these groups have different means?

-   We can perform pairwise comparisons (two-sample t tests) across all possible pairs of groups, **but** [**we must adjust (*correct*) the p-values to account for the fact that we are performing multiple hypothesis tests.**]{.fragment}

-   When we run multiple hypothesis tests simultaneously, the probability of Type 1 error is inflated.

-   We can correct for this error inflation by using a p-value correction procedure.

    -   For example, the Bonferroni correction multiplies each p-value by the number of possible pairwise comparisons.

    -   There are many other multiple comparisons p-value correction methods that we won't cover.
:::

## Multiple Comparisons

### Example Problem Ô∏èüì¶

:::{.columns}

:::{.column width=40%}

```{r}
pairwise.t.test(boxes$strength, as.factor(boxes$material), 
                pool.sd = TRUE,
                p.adjust.method = "bonf")
```
:::

:::{.column width=60%}
```{r}
ggplot(boxes, aes(x = strength, y = as.factor(material))) + 
  geom_boxplot(aes(fill = as.factor(material))) + 
  labs(x = "Compression Strength (lb)", 
       y = "Material") + 
  scale_fill_viridis_d(guide = "none") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 16), 
        axis.text = element_text(size = 16))
```

:::
:::